generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication Models
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  projects      Project[]
  sessions      Session[]
  accounts      Account[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// PLC Project Models
// ============================================

model Project {
  id              String    @id @default(cuid())
  userId          String?
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String    // Project name from ACD file
  fileName        String    // Original uploaded file name
  processorType   String?   // e.g., "1756-L83E"
  softwareVersion String?   // Studio 5000 version
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  tags            Tag[]
  programs        Program[]
  tasks           PlcTask[]
  modules         Module[]
  dataTypes       DataType[]
  chatSessions    ChatSession[]
  analysis        ProjectAnalysis?

  // New relations
  addOnInstructions AddOnInstruction[]
  alarms            AlarmDefinition[]
  messages          MessageConfig[]
  trends            TrendConfig[]

  @@index([userId])
}

model Tag {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String    // Tag name
  dataType        String    // BOOL, DINT, REAL, UDT name, etc.
  scope           String    // "controller" or program name
  description     String?
  value           String?   // Initial/default value
  externalAccess  String?   // Read/Write, Read Only, None

  // Array info
  dimensions      String?   // JSON array of dimensions

  // Alias info
  aliasFor        String?   // Target tag if this is an alias

  // Usage tracking (populated during analysis)
  usageCount      Int       @default(0)

  createdAt       DateTime  @default(now())

  @@unique([projectId, name, scope])
  @@index([projectId])
  @@index([name])
}

model Program {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  mainRoutineName String?   // Which routine is called first
  disabled        Boolean   @default(false)

  routines        Routine[]
  localTags       LocalTag[]

  @@unique([projectId, name])
  @@index([projectId])
}

model Routine {
  id              String    @id @default(cuid())
  programId       String
  program         Program   @relation(fields: [programId], references: [id], onDelete: Cascade)

  name            String
  type            String    // "Ladder", "FBD", "SFC", "ST"
  description     String?

  rungs           Rung[]
  analysis        RoutineAnalysis?

  @@unique([programId, name])
  @@index([programId])
}

model Rung {
  id              String    @id @default(cuid())
  routineId       String
  routine         Routine   @relation(fields: [routineId], references: [id], onDelete: Cascade)

  number          Int       // Rung number within routine
  comment         String?   // Rung comment
  rawText         String    // Original L5X/ACD rung text

  // Parsed instruction data (JSON)
  instructions    String?   // JSON array of parsed instructions

  // Analysis results
  explanation     String?   // Human-readable explanation from Claude

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([routineId, number])
  @@index([routineId])
}

model LocalTag {
  id              String    @id @default(cuid())
  programId       String
  program         Program   @relation(fields: [programId], references: [id], onDelete: Cascade)

  name            String
  dataType        String
  description     String?
  value           String?

  @@unique([programId, name])
  @@index([programId])
}

model PlcTask {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  type            String    // "Continuous", "Periodic", "Event"
  rate            Float?    // Scan rate in ms (for periodic)
  priority        Int?
  watchdog        Float?    // Watchdog timeout in ms
  inhibitTask     Boolean   @default(false)

  // Scheduled programs (JSON array of program names)
  scheduledPrograms String?

  @@unique([projectId, name])
  @@index([projectId])
}

model Module {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  catalogNumber   String?   // e.g., "1756-IB16"
  vendor          String?
  productType     String?
  revision        String?
  slot            Int?
  parentModule    String?   // For distributed I/O

  // Module configuration (JSON)
  config          String?

  @@unique([projectId, name])
  @@index([projectId])
}

model DataType {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  family          String?   // "StringFamily", "NoFamily"
  description     String?

  // Member definitions (JSON)
  members         String?

  @@unique([projectId, name])
  @@index([projectId])
}

// ============================================
// Add-On Instructions (AOI)
// ============================================

model AddOnInstruction {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  revision        String?
  vendor          String?

  // Parameters (JSON array)
  parameters      String?   // JSON: [{name, dataType, usage, required, visible, description}]

  // Local tags (JSON array)
  localTags       String?   // JSON: [{name, dataType, description}]

  // Logic (JSON - routines with rungs)
  logic           String?

  createdAt       DateTime  @default(now())

  @@unique([projectId, name])
  @@index([projectId])
}

// ============================================
// Alarms
// ============================================

model AlarmDefinition {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  alarmType       String    // "digital" or "analog"
  inputTag        String?   // Tag that triggers the alarm
  message         String?   // Alarm message text
  severity        String?   // "low", "medium", "high", "urgent"

  // Analog alarm limits
  highHighLimit   Float?
  highLimit       Float?
  lowLimit        Float?
  lowLowLimit     Float?
  deadband        Float?

  enabled         Boolean   @default(true)

  createdAt       DateTime  @default(now())

  @@index([projectId])
  @@index([projectId, alarmType])
}

// ============================================
// Message Instructions
// ============================================

model MessageConfig {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  messageType     String?   // "CIP", "PCCC", etc.
  path            String?   // Communication path
  sourceTag       String?
  destinationTag  String?
  description     String?

  createdAt       DateTime  @default(now())

  @@unique([projectId, name])
  @@index([projectId])
}

// ============================================
// Trends / Data Logs
// ============================================

model TrendConfig {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  samplePeriodMs  Float?
  tags            String?   // JSON array of tag names

  createdAt       DateTime  @default(now())

  @@unique([projectId, name])
  @@index([projectId])
}

// ============================================
// Cross-Reference & Analysis
// ============================================

model CrossReference {
  id              String    @id @default(cuid())
  projectId       String

  tagName         String
  routineName     String
  programName     String
  rungNumber      Int
  instructionType String    // XIC, XIO, OTE, etc.
  operandPosition Int       // Which operand in the instruction

  @@index([projectId, tagName])
  @@index([projectId, routineName])
}

// ============================================
// Learned Instructions (from AI fallback)
// ============================================

model LearnedInstruction {
  id              String    @id @default(cuid())

  instruction     String    @unique  // Instruction name (uppercase)
  category        String?   // Guessed category

  // Explanations by mode (learned from AI)
  friendlyExpl    String?   // Friendly mode explanation template
  technicalExpl   String?   // Technical mode explanation template
  operatorExpl    String?   // Operator mode explanation template

  // Metadata
  source          String    @default("ai") // "ai", "manual", "imported"
  usageCount      Int       @default(1)    // How many times this was needed
  verified        Boolean   @default(false) // Has a human verified this?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([instruction])
}

// ============================================
// Rung Explanation Cache (full rung explanations)
// ============================================

model RungExplanationCache {
  id              String    @id @default(cuid())

  // Hash of rung text for quick lookup
  rungHash        String    @unique
  rungText        String    // Original rung text

  // Explanations by mode
  friendlyExpl    String?
  technicalExpl   String?
  operatorExpl    String?

  // Metadata
  source          String    @default("library") // "library", "ai", "hybrid"
  usageCount      Int       @default(1)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([rungHash])
}

// ============================================
// AI Chat Sessions
// ============================================

model ChatSession {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title           String?   // Auto-generated from first message
  messages        ChatMessage[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([projectId])
}

model ChatMessage {
  id              String    @id @default(cuid())
  sessionId       String
  session         ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role            String    // 'user' | 'assistant'
  content         String
  metadata        Json?     // For code blocks, referenced rungs, etc.

  createdAt       DateTime  @default(now())

  @@index([sessionId])
}

// ============================================
// Pre-computed Project Analysis (Cost Optimization)
// ============================================

model ProjectAnalysis {
  id              String    @id @default(cuid())
  projectId       String    @unique
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // High-level analysis
  overview        String    // Overall project summary
  architecture    String    // Program structure and flow
  safetyNotes     String?   // Safety considerations
  concerns        String?   // Potential issues identified
  patterns        String?   // Common patterns detected

  // Tag analysis
  keyTags         String?   // Important tags and their purposes
  ioSummary       String?   // I/O organization summary

  // Status
  status          String    @default("pending") // pending, analyzing, complete, failed
  tokensUsed      Int?      // Track API usage

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model RoutineAnalysis {
  id              String    @id @default(cuid())
  routineId       String    @unique
  routine         Routine   @relation(fields: [routineId], references: [id], onDelete: Cascade)

  // Routine analysis
  purpose         String    // What this routine does
  sequenceFlow    String?   // Step-by-step sequence explanation
  keyLogic        String?   // Important logic patterns
  dependencies    String?   // Other routines it calls/depends on
  safetyNotes     String?   // Safety-related observations

  // Status
  status          String    @default("pending") // pending, analyzing, complete, failed
  tokensUsed      Int?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
